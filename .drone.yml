kind: pipeline
name: default
type: docker

platform:
  os: linux
  arch: amd64

steps:
# - name: Show flake info
#   image: nixpkgs/nix-flakes
#   commands:
#   - nix --experimental-features "nix-command flakes" flake show
#   - nix --experimental-features "nix-command flakes" flake info
#   - nix --experimental-features "nix-command flakes" flake list-inputs
#   environment:
#     NIX_PATH: nixpkgs=channel:nixos-unstable

- name: Run flake checks
  image: nixpkgs/nix-flakes
  commands:
  - nix --experimental-features "nix-command flakes" flake check --show-trace
  environment:
    NIX_PATH: nixpkgs=channel:nixos-unstable

- name: Build all hosts
  image: nixpkgs/nix-flakes
  commands:
  - nix-build krops.nix -A all
  environment:
    NIX_PATH: nixpkgs=channel:nixos-unstable

# http://plugins.drone.io/appleboy/drone-discord/
- name: Notify IRC
  image: plugins/irc
  settings:
    nick: drone-bot
    channel: "#lounge-rocks"
    host: chat.freenode.net
    port: 6667
    template: "[{{build.status}}]: {{build.message}} | #{{truncate build.commit 8}} {{build.event}} on {{repo.owner}}/{{repo.name}}/{{build.branch}} by {{build.author}} - {{build.link}}"

trigger:
  branch:
  - main
  event:
  - pull_request
  - push

---
kind: pipeline
type: docker
name: update flakes

steps:
- name: Update flake.lock
  image: nixpkgs/nix-flakes
  commands:
  - nix flake update
  environment:
    NIX_PATH: nixpkgs=channel:nixos-unstable

- name: Push updated flake.lock
  image: appleboy/drone-git-push
  settings:
    branch: update-flake
    remote: git@github.com:pinpox/nixos.git
    force: true
    commit: true
    force: true
    commit_message: "❄️ Update flake.lock"
    ssh_key:
      from_secret: deploy_key

- name: Notify IRC
  image: plugins/irc
  settings:
    nick: drone-bot
    channel: "#lounge-rocks"
    host: chat.freenode.net
    port: 6667
    template: "[{{build.status}}]: {{build.message}} | #{{truncate build.commit 8}} {{build.event}} on {{repo.owner}}/{{repo.name}}/{{build.branch}} by {{build.author}} - {{build.link}}"

trigger:
  event:
  - cron
  cron:
  - daily

---
kind: pipeline
type: docker
name: Push to cache

steps:
- name: Build hosts
  image: nixpkgs/nix-flakes
  commands:
  - nix flake update
  - nix build --profile result '.#nixosConfigurations.ahorn.config.system.build.toplevel'
  environment:
    NIX_PATH: nixpkgs=channel:nixos-unstable

- name: Push config to cache
  image: nixpkgs/nix-flakes
  commands:
  - nix copy --to ssh://cache.lounge.rocks ./result
  environment:
    NIX_PATH: nixpkgs=channel:nixos-unstable

# - name: Notify IRC
#   image: plugins/irc
#   settings:
#     nick: drone-bot
#     channel: "#lounge-rocks"
#     host: chat.freenode.net
#     port: 6667
#     template: "[{{build.status}}]: {{build.message}} | #{{truncate build.commit 8}} {{build.event}} on {{repo.owner}}/{{repo.name}}/{{build.branch}} by {{build.author}} - {{build.link}}"

# trigger:
#   branch:
#   - main

